name: Build and Notarize for macOS

on:
  push:
    tags:
      - "v*"
  schedule:
    - cron: "0 * * * *" # Run every hour

jobs:
  build-and-submit:
    if: github.event_name == 'push'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: Build for macOS
        run: |
          GOOS=darwin GOARCH=amd64 go build -o tasks-amd64 .
          GOOS=darwin GOARCH=arm64 go build -o tasks-arm64 .
          lipo -create -output tasks tasks-amd64 tasks-arm64

      - name: Create ZIP for notarization
        run: ditto -c -k --keepParent tasks tasks.zip

      - name: Submit for notarization
        env:
          AC_USERNAME: ${{ secrets.APPLE_ID }}
          AC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          SUBMISSION_ID=$(xcrun notarytool submit tasks.zip \
            --apple-id "$AC_USERNAME" \
            --password "$AC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --output-format json | jq -r '.id')
          echo "Submission ID: $SUBMISSION_ID"
          echo $SUBMISSION_ID > submission_id.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            tasks
            tasks.zip
            submission_id.txt

  check-notarization:
    if: github.event_name == 'schedule'
    runs-on: macos-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Check notarization status
        env:
          AC_USERNAME: ${{ secrets.APPLE_ID }}
          AC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ ! -f submission_id.txt ]; then
            echo "No pending notarization found"
            exit 0
          fi
          SUBMISSION_ID=$(cat submission_id.txt)
          STATUS=$(xcrun notarytool info $SUBMISSION_ID \
            --apple-id "$AC_USERNAME" \
            --password "$AC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --output-format json | jq -r '.status')
          if [ "$STATUS" = "Accepted" ]; then
            echo "Notarization successful"
            rm submission_id.txt
          elif [ "$STATUS" = "In Progress" ]; then
            echo "Notarization still in progress"
            exit 0
          else
            echo "Notarization failed with status: $STATUS"
            rm submission_id.txt
            exit 1
          fi

      - name: Staple notarization ticket
        if: success() && !contains(steps.check-notarization.outputs.status, 'In Progress')
        run: xcrun stapler staple tasks

      - name: Create release
        if: success() && !contains(steps.check-notarization.outputs.status, 'In Progress')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            tasks
            tasks.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload updated artifacts
        if: success() && contains(steps.check-notarization.outputs.status, 'In Progress')
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            tasks
            tasks.zip
            submission_id.txt
